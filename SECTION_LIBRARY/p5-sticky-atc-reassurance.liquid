{% comment %}
  Plus 5 Designs â€“ Sticky Add to Cart + Reassurance Bar
  Scaffolded as a single-file section (Liquid + CSS + JS) for easy distribution.

  Usage:
  - Add this section to a product template.
  - The sticky bar appears when the main product form is scrolled out of view.
  - Clicking the sticky button scrolls to the product form and triggers add-to-cart.

  Notes:
  - This is intentionally theme-agnostic: it tries multiple common selectors.
  - For best results, keep your themeâ€™s primary ATC button in/near the product form.
{% endcomment %}

{%- if request.page_type != 'product' -%}
  {% comment %}Only relevant on product pages{% endcomment %}
  {% break %}
{%- endif -%}

{%- assign product_obj = product -%}

<div
  class="p5-sticky-atc"
  data-section-id="{{ section.id }}"
  data-enabled="{{ section.settings.enabled | json }}"
  data-show-desktop="{{ section.settings.show_desktop | json }}"
  data-show-mobile="{{ section.settings.show_mobile | json }}"
  data-scroll-mode="{{ section.settings.show_when_scrolled | json }}"
  data-target-selector="{{ section.settings.target_selector | escape }}"
  data-offset="{{ section.settings.offset | plus: 0 }}"
  style="
    --p5satc-z: {{ section.settings.z_index }};
    --p5satc-pad-y: {{ section.settings.padding_y }}px;
    --p5satc-pad-x: {{ section.settings.padding_x }}px;
    --p5satc-gap: {{ section.settings.gap }}px;
    --p5satc-radius: {{ section.settings.radius }}px;
    --p5satc-shadow: {{ section.settings.shadow_opacity | divided_by: 100.0 }};
  "
>
  <div class="p5-sticky-atc__inner color-{{ section.settings.color_scheme }} gradient">
    <div class="p5-sticky-atc__left">
      {%- if section.settings.show_media -%}
        {%- assign img = product_obj.featured_image -%}
        {%- if img -%}
          <div class="p5-sticky-atc__media">
            {{ img | image_url: width: 120 | image_tag: widths: '80,120,160', loading: 'lazy', alt: product_obj.title }}
          </div>
        {%- endif -%}
      {%- endif -%}

      <div class="p5-sticky-atc__meta">
        {%- if section.settings.show_title -%}
          <p class="p5-sticky-atc__title">{{ product_obj.title | escape }}</p>
        {%- endif -%}

        {%- if section.settings.show_price -%}
          <p class="p5-sticky-atc__price" data-p5satc-price>
            {{ product_obj.selected_or_first_available_variant.price | money }}
          </p>
        {%- endif -%}

        {%- if section.settings.show_variant -%}
          <p class="p5-sticky-atc__variant" data-p5satc-variant>
            {{ product_obj.selected_or_first_available_variant.title | escape }}
          </p>
        {%- endif -%}

        {%- if section.settings.show_stock -%}
          <p class="p5-sticky-atc__stock" data-p5satc-stock>
            {%- if product_obj.selected_or_first_available_variant.available -%}
              {{ section.settings.in_stock_text | escape }}
            {%- else -%}
              {{ section.settings.out_of_stock_text | escape }}
            {%- endif -%}
          </p>
        {%- endif -%}
      </div>
    </div>

    <div class="p5-sticky-atc__right">
      {%- if section.settings.show_qty -%}
        <div class="p5-sticky-atc__qty">
          <button class="p5-sticky-atc__qty-btn" type="button" data-p5satc-qty-dec aria-label="Decrease quantity">âˆ’</button>
          <input class="p5-sticky-atc__qty-input" type="number" min="1" step="1" value="1" inputmode="numeric" data-p5satc-qty aria-label="Quantity" />
          <button class="p5-sticky-atc__qty-btn" type="button" data-p5satc-qty-inc aria-label="Increase quantity">+</button>
        </div>
      {%- endif -%}

      <button
        class="p5-sticky-atc__btn"
        type="button"
        data-p5satc-add
        {% if product_obj.selected_or_first_available_variant.available == false %}disabled{% endif %}
      >
        {{ section.settings.button_label | escape }}
      </button>

      {%- if section.blocks.size > 0 -%}
        <div class="p5-sticky-atc__reassurance" aria-label="Reassurance">
          {%- for block in section.blocks -%}
            {%- if block.type == 'badge' -%}
              <span class="p5-sticky-atc__badge" {{ block.shopify_attributes }}>
                {%- if block.settings.icon != blank -%}
                  <span class="p5-sticky-atc__badge-icon" aria-hidden="true">{{ block.settings.icon | escape }}</span>
                {%- endif -%}
                <span class="p5-sticky-atc__badge-text">{{ block.settings.text | escape }}</span>
              </span>
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>
  </div>
</div>

{% style %}
  .p5-sticky-atc {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: var(--p5satc-z);
    padding: var(--p5satc-pad-y) var(--p5satc-pad-x);
    transform: translateY(120%);
    transition: transform 220ms ease;
    pointer-events: none;
  }

  .p5-sticky-atc.is-active {
    transform: translateY(0);
    pointer-events: auto;
  }

  .p5-sticky-atc__inner {
    max-width: 1200px;
    margin: 0 auto;
    border-radius: var(--p5satc-radius);
    box-shadow: 0 12px 30px rgba(0, 0, 0, var(--p5satc-shadow));
    border: 1px solid rgba(var(--color-foreground), 0.12);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--p5satc-gap);
  }

  .p5-sticky-atc__left {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
    flex: 1;
  }

  .p5-sticky-atc__media img {
    width: 44px;
    height: 44px;
    object-fit: cover;
    border-radius: 10px;
    display: block;
    border: 1px solid rgba(var(--color-foreground), 0.10);
  }

  .p5-sticky-atc__meta { min-width: 0; }

  .p5-sticky-atc__title {
    margin: 0;
    font-weight: 600;
    font-size: 14px;
    line-height: 1.2;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .p5-sticky-atc__price,
  .p5-sticky-atc__variant,
  .p5-sticky-atc__stock {
    margin: 2px 0 0;
    font-size: 12px;
    line-height: 1.2;
    opacity: 0.85;
  }

  .p5-sticky-atc__right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  .p5-sticky-atc__qty {
    display: inline-flex;
    align-items: center;
    border: 1px solid rgba(var(--color-foreground), 0.16);
    border-radius: 999px;
    overflow: hidden;
    background: rgba(var(--color-background), 0.70);
  }

  .p5-sticky-atc__qty-btn {
    appearance: none;
    border: 0;
    background: transparent;
    color: rgb(var(--color-foreground));
    padding: 8px 10px;
    cursor: pointer;
    line-height: 1;
    font-size: 16px;
  }

  .p5-sticky-atc__qty-input {
    width: 54px;
    border: 0;
    background: transparent;
    color: rgb(var(--color-foreground));
    text-align: center;
    padding: 8px 6px;
    font-size: 13px;
    outline: none;
  }

  .p5-sticky-atc__btn {
    appearance: none;
    border: 0;
    border-radius: 999px;
    padding: 10px 14px;
    cursor: pointer;
    font-weight: 700;
    background: rgb(var(--color-foreground));
    color: rgb(var(--color-background));
    min-width: 150px;
  }

  .p5-sticky-atc__btn[disabled] {
    opacity: 0.55;
    cursor: not-allowed;
  }

  .p5-sticky-atc__reassurance {
    display: none;
    gap: 8px;
    align-items: center;
    margin-left: 6px;
    opacity: 0.9;
  }

  .p5-sticky-atc__badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(var(--color-foreground), 0.12);
    background: rgba(var(--color-background), 0.65);
    white-space: nowrap;
  }

  @media screen and (min-width: 990px) {
    .p5-sticky-atc__reassurance { display: inline-flex; }
  }

  @media screen and (max-width: 749px) {
    .p5-sticky-atc__inner { padding: 10px; }
    .p5-sticky-atc__btn { min-width: 120px; }
    .p5-sticky-atc__qty { display: none; }
  }

  /* Visibility toggles */
  @media screen and (min-width: 750px) {
    .p5-sticky-atc[data-show-desktop="false"] { display: none !important; }
  }
  @media screen and (max-width: 749px) {
    .p5-sticky-atc[data-show-mobile="false"] { display: none !important; }
  }
{% endstyle %}

<script>
  (() => {
    const root = document.querySelector('.p5-sticky-atc[data-section-id="{{ section.id }}"]');
    if (!root) return;
    if (root.dataset.enabled !== 'true') return;

    const offset = parseInt(root.dataset.offset || '0', 10) || 0;
    const targetSelector = root.dataset.targetSelector || 'form[action^="/cart/add"]';

    const qInput = root.querySelector('[data-p5satc-qty]');
    const qDec = root.querySelector('[data-p5satc-qty-dec]');
    const qInc = root.querySelector('[data-p5satc-qty-inc]');

    const safeQty = () => {
      const n = parseInt(qInput?.value || '1', 10);
      if (!Number.isFinite(n) || n < 1) return 1;
      return n;
    };

    if (qDec && qInput) qDec.addEventListener('click', () => (qInput.value = String(Math.max(1, safeQty() - 1))));
    if (qInc && qInput) qInc.addEventListener('click', () => (qInput.value = String(safeQty() + 1)));

    const findTarget = () => {
      const sel = (targetSelector || '').trim();
      if (sel) {
        const el = document.querySelector(sel);
        if (el) return el;
      }

      // Fallbacks for common themes
      return (
        document.querySelector('form[action^="/cart/add"]') ||
        document.querySelector('[data-product-form]') ||
        document.querySelector('product-form') ||
        document.querySelector('form')
      );
    };

    const findAtcButton = (target) => {
      if (!target) return null;
      return (
        target.querySelector('button[name="add"]') ||
        target.querySelector('[type="submit"]') ||
        document.querySelector('button[name="add"]')
      );
    };

    const isOutOfView = (el) => {
      if (!el) return true;
      const r = el.getBoundingClientRect();
      return r.bottom <= offset || r.top >= (window.innerHeight - offset);
    };

    const update = () => {
      const mode = root.dataset.scrollMode === 'true';
      if (!mode) {
        root.classList.add('is-active');
        return;
      }
      const target = findTarget();
      if (isOutOfView(target)) root.classList.add('is-active');
      else root.classList.remove('is-active');
    };

    const onAdd = () => {
      const target = findTarget();
      const btn = findAtcButton(target);

      // Scroll to target for best UX
      if (target && typeof target.scrollIntoView === 'function') {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      // If we have a quantity input, try to sync it into the closest form quantity.
      if (qInput && target) {
        const mainQty = target.querySelector('input[name="quantity"]');
        if (mainQty) mainQty.value = String(safeQty());
      }

      // Trigger click after a short delay (allow scroll)
      window.setTimeout(() => {
        if (btn && !btn.disabled) btn.click();
      }, 150);
    };

    root.querySelector('[data-p5satc-add]')?.addEventListener('click', onAdd);

    // Update dynamic text on variant changes (theme-agnostic best effort)
    const variantEl = root.querySelector('[data-p5satc-variant]');
    const priceEl = root.querySelector('[data-p5satc-price]');
    const stockEl = root.querySelector('[data-p5satc-stock]');

    const onVariantEvent = (e) => {
      const v = e?.detail?.variant;
      if (!v) return;
      if (variantEl) variantEl.textContent = v.title || '';
      if (priceEl && typeof v.price === 'number') {
        // price is in cents in many themes; leave as-is if unknown.
      }
      if (stockEl) stockEl.textContent = v.available ? {{ section.settings.in_stock_text | json }} : {{ section.settings.out_of_stock_text | json }};
    };

    window.addEventListener('variant:change', onVariantEvent);

    update();
    window.addEventListener('scroll', update, { passive: true });
    window.addEventListener('resize', update);
  })();
</script>

{% schema %}
{
  "name": "P5 â€” Sticky Add to Cart + Reassurance",
  "tag": "section",
  "class": "section",
  "settings": [
    {"type": "checkbox", "id": "enabled", "label": "Enable", "default": true},

    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1",
      "options": [
        {"value": "accent-1", "label": "Accent 1"},
        {"value": "accent-2", "label": "Accent 2"},
        {"value": "background-1", "label": "Background 1"},
        {"value": "background-2", "label": "Background 2"},
        {"value": "inverse", "label": "Inverse"}
      ]
    },

    {"type": "header", "content": "Behavior"},
    {"type": "checkbox", "id": "show_when_scrolled", "label": "Only show when main form is scrolled out of view", "default": true},
    {"type": "text", "id": "target_selector", "label": "Target selector (main product form)", "default": "form[action^='/cart/add']"},
    {"type": "range", "id": "offset", "label": "Scroll offset", "min": 0, "max": 200, "step": 10, "unit": "px", "default": 0},

    {"type": "header", "content": "Content"},
    {"type": "checkbox", "id": "show_media", "label": "Show product image", "default": true},
    {"type": "checkbox", "id": "show_title", "label": "Show product title", "default": true},
    {"type": "checkbox", "id": "show_price", "label": "Show price", "default": true},
    {"type": "checkbox", "id": "show_variant", "label": "Show variant title", "default": false},
    {"type": "checkbox", "id": "show_stock", "label": "Show stock text", "default": true},
    {"type": "text", "id": "in_stock_text", "label": "In stock text", "default": "In stock"},
    {"type": "text", "id": "out_of_stock_text", "label": "Out of stock text", "default": "Sold out"},
    {"type": "checkbox", "id": "show_qty", "label": "Show quantity selector (desktop only)", "default": false},
    {"type": "text", "id": "button_label", "label": "Button label", "default": "Add to cart"},

    {"type": "header", "content": "Layout"},
    {"type": "range", "id": "padding_y", "label": "Outer padding (Y)", "min": 0, "max": 32, "step": 2, "unit": "px", "default": 10},
    {"type": "range", "id": "padding_x", "label": "Outer padding (X)", "min": 0, "max": 32, "step": 2, "unit": "px", "default": 10},
    {"type": "range", "id": "gap", "label": "Gap", "min": 6, "max": 24, "step": 2, "unit": "px", "default": 12},
    {"type": "range", "id": "radius", "label": "Corner radius", "min": 0, "max": 24, "step": 2, "unit": "px", "default": 14},
    {"type": "range", "id": "shadow_opacity", "label": "Shadow opacity", "min": 0, "max": 40, "step": 2, "unit": "%", "default": 18},
    {"type": "range", "id": "z_index", "label": "Z-index", "min": 10, "max": 100, "step": 1, "default": 50},

    {"type": "header", "content": "Visibility"},
    {"type": "checkbox", "id": "show_desktop", "label": "Show on desktop", "default": true},
    {"type": "checkbox", "id": "show_mobile", "label": "Show on mobile", "default": true}
  ],
  "blocks": [
    {
      "type": "badge",
      "name": "Reassurance badge",
      "settings": [
        {"type": "text", "id": "icon", "label": "Icon (emoji/text)", "default": "ðŸšš"},
        {"type": "text", "id": "text", "label": "Text", "default": "Fast dispatch"}
      ]
    }
  ],
  "presets": [
    {
      "name": "P5 â€” Sticky Add to Cart + Reassurance",
      "blocks": [
        {"type": "badge", "settings": {"icon": "ðŸšš", "text": "Fast dispatch"}},
        {"type": "badge", "settings": {"icon": "ðŸ”’", "text": "Secure checkout"}},
        {"type": "badge", "settings": {"icon": "âœ…", "text": "30-day returns"}}
      ]
    }
  ]
}
{% endschema %}
